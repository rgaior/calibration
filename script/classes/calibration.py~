import utils
import detector
from numpy import interp
import numpy as np

# files containing the the adjustable resistor calibration
helixfile = '/potar/potarHelix.txt'
hornfile = '/potar/potarCornet.txt'

#file containing the detector parameters (from installation document)
installhelix = '/install/installHelix.txt'
installhorn = '/install/installCornet.txt'

#point set before installation in number of rotation
refrotationhelix = 0
refrotationhorn = -13.5


class Calibration:
    def __init__(self, datafolder = '' ,type =''):
        self.type = type
        
        self.datafolder = datafolder
        #adjustable resistor
        self.resistor = []
        #filter on board:
        self.boardfilter = []
        #lna gain
        self.lna = []
        #other filter (like biasT filter): 
        self.other = []
        #cable attenuation 
        self.cable = []
        #include the detector (with its position and installation data)
        self.det = []
        #value of the board slope in db/V 
        self.boardslope = -10.4 # (cf thesis 1/0.0234*4.1)

        #reset the detectors
        self.det = []
        # set the folder:
        if self.type.lower() == 'cornet' or type.lower() == 'horn':
            self.datafolder = datafolder + '/horn/'
        elif self.type.lower() == 'helix' or self.type.lower() == 'helice':
            self.datafolder = datafolder + '/helix/'
        else:
            print 'not the right type of detector type, it should be either horn or helix'

    
    def fillpotardata(self):
        resistorfile = self.datafolder + 'potar/calib.txt'
        self.resistor = utils.readtwocolumns(resistorfile)

    def fillboardfilter(self):
        boardfilterdata = self.datafolder + 'filter/boardfilterconst.txt'
        self.boardfilter = utils.readtwocolumns(boardfilterdata)
        
    # here we have values from constructor or data measured by Jacques.
    # you have to choose, or default is measured data
    def fillbiastfilter(self,constordata=None):
        if self.type== 'horn':
            return
        biastfilterdata = []
        if constordata is None: 
            biastfilterdata = self.datafolder + 'filter/biasTfilterdata.txt'
        elif constordata == 'const':
            biastfilterdata = self.datafolder + 'filter/biasTfilterconst.txt'
        elif constordata == 'data':
            biastfilterdata = self.datafolder + 'filter/biasTfilterdata.txt'
        self.otherfilter = utils.readtwocolumns(biastfilterdata)

    def fillcable(self):
        cablename = self.datafolder + 'cable/cabledata.txt'
        self.cable = utils.readtwocolumns(cablename)

    def filllna(self):
        lnaname = self.datafolder + 'gain/lnadata.txt'
        self.lna = utils.readtwocolumns(lnaname)

    # fill one detector
    def filldetector(self, name):
        #install file :
        file = self.datafolder + '/install/' + 'install.txt' 
        det = detector.Detector()
        det.fill(file,name)
        if (det.tankid == 0):
            print 'detector not filled ! '
        else: self.det.append(det)

    #fill the detectors parameters from a file in /data
    def filldetectors(self):
        file = self.datafolder + '/install/' + 'install.txt' 
        f = open(file, 'r+')
        counter = 0
        for l in f:
            if counter == 0:
                counter +=1
                continue
            det = detector.Detector()
            det.fillwithline(l.split())                
            det.type = type
            if (det.tankid == 0):
                print 'detector not filled ! '
            else:self.det.append(det)

    def seterrorrotation(self, det, deltarotation):
        refrotation = 0
        ## done that way because data didn't give something very regular 
        fit = np.polyfit(self.resistor[0],self.resistor[1],2)
        errorfunction = np.poly1d([2*fit[0], fit[1]])
        refrotation = refrotationhorn
        det.errorrotation = errorfunction(refrotation + det.rotation)*deltarotation

    def getdetector(self,name):
        found = False
        for det in self.det:
            if det.name.lower() == name.lower():
                found = True
                return det
        if found == False:
            print '!!! couldn t find the det with the name: ' , name
            
    ## the procedure to find the power at the installation 
    ## is described in a note.
    ## we first find the power at -2V from the resistor calibration
    ## then we exptrapolate knowing the slope of the board.
    def getpoweratinstall(self, det, whatbaseline):
        #value of the nr of rotation set before installation (hardcoded)
        # find the power at -2V from calibration
        ref = 0 
        rotation = 0 
        poweratminus2 = 0
        ref = refrotationhorn
        rotation = ref + det.rotation
        poweratminus2 = interp(rotation,self.resistorhorn[0],self.resistorhorn[1])
        if det.name.lower()=='nono':
            poweratminus2 = -29.2
        #now get the voltage difference between -2V and the voltage at install
        if whatbaseline == 'install':
            deltav = utils.adctov_board(det.meanBL) - (-2)
        elif whatbaseline == 'monit':
            deltav = utils.adctov_board(det.meanBLyear) - (-2)
        poweratinstall = poweratminus2 + self.boardslope*deltav
        return poweratinstall
